- name: Updating "{{ service_name }}" server codebase and starting its service.
  hosts: all
  remote_user: abhinav
  become: yes
  vars: 
    repo_dir: /data/codebase/connecto
    node_version: 8.15.0
  tasks:

   - name: stopping nginx service
     service:
        name: nginx
        state: stopped
     when: nginxFlag | default(False)


   - name: Performing git checkout in the specified directory "{{ repo_dir }}"
     become_user: connecto
     become: yes
     command: git checkout .
     args:
        chdir: "{{ repo_dir }}"
     
        
   - name: switching branch to master branch
     become_user: connecto
     become: yes
     command: git checkout master
     args:
        chdir: "{{ path }}"


   - name: Taking pull from bitbucket master branch
     become_user: connecto
     become: yes
     git:
        repo: ssh://bitbucket.org/girnarsoftware/connecto.git
        dest: "{{ repo_dir }}"
        update: yes
        version: master
        accept_hostkey: yes
        key_file: /home/connecto/.ssh/id_rsa
     

   - name: Switching to node version {{ node_version }} as specified by user
     become_user: connecto
     become: yes
     shell: "source /home/connecto/.nvm/nvm.sh && nvm use {{ node_version }}" 
     args: 
        executable: /bin/bash


   - name: Running npm install in directory "{{ path }}"
     become_user: connecto
     become: yes
     npm: 
        path: "{{ path }}"
        state: present
     environment:
        PATH: /home/connecto/.nvm/versions/node/v{{ node_version }}/bin


   - name: Running npm install in directory {{ repo_dir }}/lib as well"
     become_user: connecto
     become: yes
     npm: 
        path: "{{ repo_dir }}/lib"
        state: present
     environment:
        PATH: /home/connecto/.nvm/versions/node/v{{ node_version }}/bin
     when: npmFlag | default(False)


   - name: Restarting the "{{ service_name }}" service
     become_user: connecto
     become: yes
     command: pm2 restart "{{ service_name }}"
     args:
        chdir: "{{ repo_dir }}"
     environment:
        PATH: /home/connecto/.nvm/versions/node/v{{ node_version }}/bin
     
     
   - name: starting nginx service
     service:
        name: nginx
        state: started
     when: nginxFlag | default(False)